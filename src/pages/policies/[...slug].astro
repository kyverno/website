---
// Import collection
import { getCollection } from 'astro:content'
import yaml from 'js-yaml'
import DefaultLayout from '../../layouts/DefaultLayout.astro'
import { Header } from '../../sections/Header'
import { YamlCodeBlock } from '../../components/YamlCodeBlock.jsx'
import { PolicyActionButtons } from '../../components/policy/PolicyActionButtons.jsx'
import { RelatedPolicyCard } from '../../components/policy/RelatedPolicyCard.jsx'
import {
  formatCategoryLabel,
  formatSeverityLabel,
  getCategoryColor,
  getSeverityColor,
  isPolicyNew,
} from '../../components/policy/utils'

export async function getStaticPaths() {
  const policies = await getCollection('policies')
  return policies.map((policy) => ({
    params: { slug: policy.id },
    props: { policy },
  }))
}

const { policy } = Astro.props
const { data } = policy

// Extract YAML content from policy body
let yamlContent = ''
const bodyContent = policy.body || ''
// Try multiple patterns to extract YAML - be more flexible with closing backticks
const yamlMatch =
  bodyContent.match(/```\s*yaml\s*\n([\s\S]*?)\n```/s) ||
  bodyContent.match(/```\s*yml\s*\n([\s\S]*?)\n```/s) ||
  bodyContent.match(/```\s*yaml\s*\n([\s\S]*?)```/s) ||
  bodyContent.match(/```\s*yml\s*\n([\s\S]*?)```/s)
if (yamlMatch && yamlMatch[1]) {
  let rawYaml = yamlMatch[1]
  // Remove only leading/trailing newlines (not spaces/tabs)
  rawYaml = rawYaml.replace(/^[\r\n]+|[\r\n]+$/g, '')

  // Verify it looks like a Kyverno policy
  if (rawYaml.includes('apiVersion:') && rawYaml.includes('kind:')) {
    try {
      // Parse and re-stringify YAML to normalize formatting (consistent spacing/tabs)
      const parsed = yaml.load(rawYaml)
      if (parsed) {
        // Use js-yaml to format with consistent indentation (2 spaces)
        yamlContent = yaml.dump(parsed, {
          indent: 2,
          lineWidth: -1, // No line wrapping
          noRefs: true,
          quotingType: '"',
          forceQuotes: false,
        })
        // Remove trailing newline that yaml.dump adds
        yamlContent = yamlContent.replace(/\n$/, '')
      }
    } catch (error) {
      // If parsing fails, fall back to raw YAML
      console.warn('Failed to parse YAML, using raw content:', error)
      yamlContent = rawYaml
    }
  } else {
    console.warn('Extracted YAML does not appear to be a valid policy')
    yamlContent = ''
  }
}

// Extract metadata
const category = data.category || 'validate'
const severity = data.severity || 'medium'
const description = data.description || null
const isNew = isPolicyNew(data.createdAt)

// Construct GitHub URL from policy ID
const githubUrl = `https://github.com/kyverno/policies/blob/main/${policy.id}.yaml`

// Get all policies for related policies section
const allPolicies = await getCollection('policies')
const relatedPolicies = allPolicies
  .filter((p) => {
    // Same category or shared tags
    const sameCategory = p.data.category === category
    const sharedTags =
      p.data.tags &&
      data.tags &&
      p.data.tags.some((tag) => data.tags.includes(tag))
    return (
      (sameCategory || sharedTags) &&
      p.id !== policy.id &&
      p.data.title !== data.title
    )
  })
  .slice(0, 3)
---

<DefaultLayout>
  <Header client:load />
  <div class="max-w-[1600px] mx-auto px-6 py-12">
    <!-- Back Button -->
    <a
      href="/policies/"
      class="inline-flex items-center gap-2 text-theme-secondary hover:text-primary-100 transition-colors mb-8 group"
    >
      <svg
        width="20"
        height="20"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        class="group-hover:-translate-x-1 transition-transform"
      >
        <path d="M15 18l-6-6 6-6"></path>
      </svg>
      <span class="text-sm font-medium">Back to Policies</span>
    </a>

    <!-- Hero Section -->
    <header class="mb-12">
      <h1
        class="text-4xl md:text-5xl font-bold text-theme-primary mb-6 leading-tight"
      >
        {data.title}
      </h1>
      {
        description && (
          <p class="text-theme-secondary text-lg leading-relaxed max-w-4xl mb-6">
            {description}
          </p>
        )
      }

      <!-- Action Buttons -->
      <PolicyActionButtons
        yamlUrl={githubUrl}
        yamlContent={yamlContent}
        client:load
      />
    </header>

    <!-- Main Content Layout -->
    <div class="space-y-8">
      <!-- Top Section: Policy Definition and Sidebar -->
      <div class="grid grid-cols-1 lg:grid-cols-[1fr_380px] gap-8 min-w-0">
        <!-- Policy Content (Left) -->
        <div class="min-w-0">
          <!-- Policy Definition -->
          {
            yamlContent && (
              <div class="bg-dark-50 border border-stroke rounded-2xl p-8 shadow-lg min-w-0 max-w-full overflow-hidden">
                <h2 class="text-theme-primary text-xl font-bold mb-6">
                  Policy Definition
                </h2>
                <div class="min-w-0 max-w-full overflow-hidden rounded-lg bg-dark-100 border border-stroke">
                  <YamlCodeBlock code={yamlContent} client:load />
                </div>
              </div>
            )
          }
        </div>

        <!-- Metadata Sidebar (Right) -->
        <aside class="h-fit">
          <div
            class="bg-dark-50 border border-stroke rounded-2xl p-6 shadow-lg space-y-6 ml-0 lg:ml-4"
          >
            <!-- 1. Category and Severity Badges (grouped together) -->
            <div class="flex flex-col sm:flex-row gap-4">
              <div class="flex-1">
                <dt
                  class="text-xs font-semibold text-theme-tertiary uppercase tracking-wider mb-3"
                >
                  Category
                </dt>
                <dd>
                  <span
                    class={`inline-block px-3 py-1.5 rounded-lg text-xs font-bold uppercase tracking-wider border ${getCategoryColor(category)}`}
                  >
                    {formatCategoryLabel(category)}
                  </span>
                </dd>
              </div>
              <div class="flex-1">
                <dt
                  class="text-xs font-semibold text-theme-tertiary uppercase tracking-wider mb-3"
                >
                  Severity
                </dt>
                <dd>
                  <span
                    class={`inline-block px-3 py-1.5 rounded-lg text-xs font-bold uppercase tracking-wider border ${getSeverityColor(severity)}`}
                  >
                    {formatSeverityLabel(severity)}
                  </span>
                </dd>
              </div>
            </div>

            <!-- 2. Type -->
            <div>
              <dt
                class="text-xs font-semibold text-theme-tertiary uppercase tracking-wider mb-2"
              >
                Type
              </dt>
              <dd class="text-theme-primary font-mono text-sm font-medium">
                {data.type}
              </dd>
            </div>

            <!-- 3. Applies To -->
            {
              data.subjects && data.subjects.length > 0 && (
                <div>
                  <dt class="text-xs font-semibold text-theme-tertiary uppercase tracking-wider mb-3">
                    Applies To
                  </dt>
                  <dd class="flex flex-wrap gap-2">
                    {data.subjects.map((subject) => (
                      <span class="px-3 py-1.5 bg-stroke/50 text-theme-secondary border border-stroke rounded-lg text-sm font-medium">
                        {subject}
                      </span>
                    ))}
                  </dd>
                </div>
              )
            }

            <!-- 4. Kyverno Min Version -->
            {
              data.version && (
                <div>
                  <dt class="text-xs font-semibold text-theme-tertiary uppercase tracking-wider mb-2">
                    Kyverno Min Version
                  </dt>
                  <dd class="text-theme-primary text-lg font-bold">
                    v{data.version}+
                  </dd>
                </div>
              )
            }

            <!-- 5. Tags -->
            {
              data.tags && data.tags.length > 0 && (
                <div>
                  <dt class="text-xs font-semibold text-theme-tertiary uppercase tracking-wider mb-3">
                    Tags
                  </dt>
                  <dd class="flex flex-wrap gap-2">
                    {data.tags.map((tag) => (
                      <span class="px-2 py-0.5 text-xs text-theme-tertiary bg-stroke/50 rounded">
                        #{tag}
                      </span>
                    ))}
                  </dd>
                </div>
              )
            }

            <!-- New Badge (if applicable) -->
            {
              isNew && (
                <div>
                  <dt class="text-xs font-semibold text-theme-tertiary uppercase tracking-wider mb-3">
                    Status
                  </dt>
                  <dd>
                    <span class="inline-block px-3 py-1.5 rounded-lg text-xs font-bold uppercase tracking-wider border text-purple-400 bg-purple-950/50 border-purple-900/50">
                      New
                    </span>
                  </dd>
                </div>
              )
            }

            <!-- Last Updated (if available) -->
            {
              policy.data.lastUpdated && (
                <div>
                  <dt class="text-xs font-semibold text-theme-tertiary uppercase tracking-wider mb-2">
                    Last Updated
                  </dt>
                  <dd class="text-theme-tertiary text-sm">
                    {new Date(policy.data.lastUpdated).toLocaleDateString()}
                  </dd>
                </div>
              )
            }
          </div>
        </aside>
      </div>

      <!-- Related Policies Section (below on mobile, full width on desktop) -->
      {
        relatedPolicies.length > 0 && (
          <div className="bg-dark-50 border border-stroke rounded-2xl p-6 shadow-lg">
            <h2 class="text-theme-primary text-xl font-bold mb-6">
              Related Policies
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 auto-rows-fr">
              {relatedPolicies.map((relatedPolicy) => (
                <RelatedPolicyCard policy={relatedPolicy} client:load />
              ))}
            </div>
          </div>
        )
      }
    </div>

    <!-- Hidden element to store YAML for copy functionality (fallback) -->
    {
      yamlContent && (
        <div
          id="yaml-content-data"
          data-yaml={JSON.stringify(yamlContent)}
          style="display: none;"
        />
      )
    }
  </div>
</DefaultLayout>
