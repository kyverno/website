---
title: 'Generate Kasten Policy from Preset'
category: generate
severity: medium
type: ClusterPolicy
subjects:
  - Policy
tags: []
version: 1.12.0
description: 'Generates a Kasten policy for a new namespace that includes a valid "dataprotection" label, if the policy does not already exist. Use with "kasten-validate-ns-by-preset-label" policy to require "dataprotection" labeling on new namespaces.'
isNew: true
---

## Policy Definition

<a href="https://github.com/kyverno/policies/raw/main/kasten/kasten-generate-policy-by-preset-label/kasten-generate-policy-by-preset-label.yaml" target="-blank">/kasten/kasten-generate-policy-by-preset-label/kasten-generate-policy-by-preset-label.yaml</a>

```yaml
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: kasten-generate-policy-by-preset-label
  annotations:
    policies.kyverno.io/title: Generate Kasten Policy from Preset
    policies.kyverno.io/category: Veeam Kasten
    policies.kyverno.io/subject: Policy
    kyverno.io/kyverno-version: 1.12.1
    policies.kyverno.io/minversion: 1.12.0
    kyverno.io/kubernetes-version: 1.24-1.30
    policies.kyverno.io/description: Generates a Kasten policy for a new namespace that includes a valid "dataprotection" label, if the policy does not already exist. Use with "kasten-validate-ns-by-preset-label" policy to require "dataprotection" labeling on new namespaces.
spec:
  rules:
    - name: kasten-generate-policy-by-preset-label
      match:
        any:
          - resources:
              kinds:
                - Namespace
              selector:
                matchExpressions:
                  - key: dataprotection
                    operator: In
                    values:
                      - gold
                      - silver
                      - bronze
      context:
        - name: existingPolicy
          apiCall:
            urlPath: /apis/config.kio.kasten.io/v1alpha1/namespaces/kasten-io/policies
            jmesPath: items[][[@.spec.presetRef][?name=='{{ request.object.metadata.labels.dataprotection }}'] && [@.spec.selector.matchExpressions[].values[?@=='{{ request.namespace }}']]][][][][] | length(@)
      preconditions:
        any:
          - key: '{{ existingPolicy }}'
            operator: Equals
            value: 0
      generate:
        apiVersion: config.kio.kasten.io/v1alpha1
        kind: Policy
        name: '{{ request.namespace }}-{{ request.object.metadata.labels.dataprotection }}-backup'
        namespace: kasten-io
        data:
          spec:
            comment: Auto-generated by Kyverno
            paused: false
            actions:
              - action: backup
            presetRef:
              name: '{{ request.object.metadata.labels.dataprotection }}'
              namespace: kasten-io
            selector:
              matchExpressions:
                - key: k10.kasten.io/appNamespace
                  operator: In
                  values:
                    - '{{ request.namespace }}'
```
