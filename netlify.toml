[build]
  command = "npm ci && npm run build"
  publish = "dist"

  [build.environment]
    NODE_VERSION = "24.11.1"
    GO_VERSION = "1.24.1"
    ASTRO_TELEMETRY_DISABLED = "1"
    SITE_URL = "https://kyverno.io/"

# --- Production (main branch) ---
[context.production]
  command = "npm ci && npm run build"
  publish = "dist"

  [context.production.environment]
    NODE_ENV = "production"
    SITE_URL = "https://kyverno.io/"
    ASTRO_ENV = "production"

# --- Deploy Previews (PRs) ---
[context.deploy-preview]
  command = "npm ci && npm run build"
  publish = "dist"

  [context.deploy-preview.environment]
    NODE_ENV = "production"
    ASTRO_ENV = "preview"
    SITE_URL = "$DEPLOY_PRIME_URL"

# --- Branch Deploys (non-main branches) ---
[context.branch-deploy]
  command = "npm ci && npm run build"
  publish = "dist"

  [context.branch-deploy.environment]
    NODE_ENV = "production"
    ASTRO_ENV = "branch"
    SITE_URL = "$DEPLOY_PRIME_URL"

# --- Redirects ---
[[redirects]]
  from = "/*"
  to = "/index.html"
  status = 200

[[redirects]]
  from = "/docs/policy-types/*"
  to = "/docs/policy-types/cel-policies/*"
  status = 301

# --- Headers ---
[[headers]]
  for = "/*"
  [headers.values]
    X-Frame-Options = "SAMEORIGIN"

[[headers]]
  for = "/blog/index.xml"
  [headers.values]
    access-control-allow-origin = "*"